#include <Arduino.h>
#include <WiFi.h>
#include <WiFiMulti.h>
#include <HTTPClient.h>
#include <AsyncUDP.h>
#include <string.h>
#include <Preferences.h>
#include <esp_sleep.h>
#include <esp_wifi.h>
#include <driver/touch_pad.h>
#include <driver/rtc_io.h>
#include "sonos.h"


#include <odroid_go.h>

#include "config.h"
#include "button_wrapper.h"

static IPAddress targetSonos;

// Second layer of sonos operation wrapper to handle the rediscovery logic
void doSonos(int (*operation)(HTTPClient *http, IPAddress targetSonos)) {
    if (!targetSonos) {
        targetSonos = discoverSonos(std::string(SONOS_UID));
    }
    if (!targetSonos) {
        ESP_LOGE(TAG, "Couldn't find the right sonos, bailing");
        return;
    }

    int error = sonosOperation(operation, targetSonos);
    if (error) {
        // try rediscovering
        targetSonos = discoverSonos(std::string(SONOS_UID));
    }
}



boolean connectWifi() 
{
    WiFi.mode(WIFI_STA);
    WiFi.begin("Pfannekuchen", "kabelbeisser");
    Serial.write("Waiting for WiFi to connect...\n");
        
    uint8_t wifiTries = 0;
    wl_status_t status = WiFi.status();
    while (status != WL_CONNECTED && status != WL_CONNECT_FAILED && wifiTries < 50) {
        delay(50);
        status = WiFi.status();
        wifiTries += 1;
    }

    if (!WiFi.isConnected() ) {
            GO.lcd.println("WiFi connect failed, restarting");
            delay(1000);
            ESP.restart();
    
    }
    GO.lcd.println("WiFi connect succeeded");
    return true;
}

void setup() {
  GO.Speaker.mute();
  Serial.begin(115200);
  GO.begin();
  GO.lcd.setTextSize(2);
  GO.lcd.println("Starting");
  //connectWifi();
}
 
void updateSonosScreen()
{
    GO.lcd.clear();
    GO.lcd.setCursor(0,0);
    GO.lcd.printf("Playstate: %s",sonos_parameters.PlayState.c_str());
    GO.lcd.printf("\n");
    GO.lcd.printf("Volume: ");
    
}

void handleButtons()
{
  if(VOLUME_UP_BUTTON)
  {
      doSonos(volumeUp);
      updateSonosScreen();
  }
  if(VOLUME_DOWN_BUTTON)
  {
      GO.lcd.printf("Volume down\n");
      updateSonosScreen();
  }
  if(NEXT_TRACK_BUTTON)
  {
      GO.lcd.printf("Next track\n");
      doSonos(sonosNext);
  }
  if(PLAY_PAUSE_BUTTON)
  {

      doSonos(sonosPlay);
      updateSonosScreen();
  }


}
 
void loop() {
  GO.update();
  //handleButtons();
  delay(200);
}